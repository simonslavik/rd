SELECT sod.SalesOrderID, pc.Name as NazevKategorie,  ps.Name NazevPodKategorie, pp.Name as NazevProduktu, OrderDate as DatumObjednáni, ShipDate as DatumOdesláni, Day(ShipDate) - Day(OrderDate)  AS Rozdíl, sod.OrderQty*sod.UnitPrice as CelkovyProdej, Year(sod.ModifiedDate) as Rok, Month(sod.ModifiedDate) as Mesic, DATEPART(QUARTER, sod.ModifiedDate) as Kvartal
FROM sales.SalesOrderDetail sod 
join sales.SalesOrderHeader soh on sod.SalesOrderID=soh.SalesOrderID 
, Production.Product pp
join Production.ProductSubcategory ps on ps.ProductSubcategoryID=pp.ProductSubcategoryID 
join Production.ProductCategory pc on pc.ProductCategoryID=ps.ProductCategoryID 
where (Year(sod.ModifiedDate) = '2011' OR Year(sod.ModifiedDate) = '2012') AND (DATEPART(QUARTER, sod.ModifiedDate) = '4') AND (sod.ProductID = pp.ProductID)



SELECT  NazevKategorie, SUM(CelkovyProdej) as CelkovýProdej, Rozdíl as RozdílveDnech,Rok, Kvartal, 
CASE WHEN SUM(CelkovyProdej)<100000 THEN 'Podprumerný prodej'​
     WHEN SUM(CelkovyProdej)>5000000 THEN 'Nadprúmerný prodej'​
     ELSE 'Prumerný prodej' END AS Výsledek
FROM (
SELECT sod.SalesOrderID, pc.Name as NazevKategorie,  ps.Name NazevPodKategorie, pp.Name as NazevProduktu, OrderDate as DatumObjednáni, ShipDate as DatumOdesláni, Day(ShipDate) - Day(OrderDate)  AS Rozdíl, sod.OrderQty*sod.UnitPrice as CelkovyProdej, Year(sod.ModifiedDate) as Rok, Month(sod.ModifiedDate) as Mesic, DATEPART(QUARTER, sod.ModifiedDate) as Kvartal
FROM sales.SalesOrderDetail sod 
join sales.SalesOrderHeader soh on sod.SalesOrderID=soh.SalesOrderID 
, Production.Product pp
join Production.ProductSubcategory ps on ps.ProductSubcategoryID=pp.ProductSubcategoryID 
join Production.ProductCategory pc on pc.ProductCategoryID=ps.ProductCategoryID 
where (Year(sod.ModifiedDate) = '2011' OR Year(sod.ModifiedDate) = '2012') AND (DATEPART(QUARTER, sod.ModifiedDate) = '4') 
) as ss
group by NazevKategorie, Rozdíl, Kvartal, Rok
order by Rozdíl DESC
